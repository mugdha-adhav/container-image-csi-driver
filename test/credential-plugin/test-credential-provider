#!/bin/bash

# This is a simple credential provider plugin for testing
# It provides credentials for images from a specific registry

IMAGE=$1
if [[ "$IMAGE" == "" ]]; then
  echo "Usage: $0 --image=<image>"
  exit 1
fi

# Extract image argument
if [[ "$IMAGE" == "--image="* ]]; then
  IMAGE="${IMAGE#--image=}"
else
  echo "Usage: $0 --image=<image>"
  exit 1
fi

# Check if the image is from our test registry
if [[ "$IMAGE" == *"test-registry.example.com"* ]]; then
  # Return credentials for the test registry
  cat << EOF
{
  "auth": {
    "username": "testuser",
    "password": "testpassword"
  }
}
EOF
  exit 0
fi

# Check if the image is from Amazon ECR
if [[ "$IMAGE" == *".dkr.ecr."*".amazonaws.com"* ]]; then
  # Extract the region from the ECR URL
  REGION=$(echo "$IMAGE" | sed -n 's/.*\.dkr\.ecr\.\([^.]*\)\.amazonaws\.com.*/\1/p')
  
  # Check if AWS CLI is available
  if command -v aws >/dev/null 2>&1; then
    # Get ECR authentication token
    TOKEN=$(aws ecr get-login-password --region "$REGION" 2>/dev/null)
    
    if [ $? -eq 0 ] && [ -n "$TOKEN" ]; then
      # Return credentials for ECR
      cat << EOF
{
  "auth": {
    "username": "AWS",
    "password": "$TOKEN"
  }
}
EOF
      exit 0
    else
      echo "Failed to get ECR token from AWS CLI" >&2
    fi
  else
    echo "AWS CLI not available for ECR authentication" >&2
  fi
  
  # If we couldn't get a token via AWS CLI, return empty credentials
  echo '{}'
  exit 0
fi

# No credentials for other registries
echo '{}'
exit 0
