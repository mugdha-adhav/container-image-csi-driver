#!/bin/bash

# Extract image argument from command line
for arg in "$@"; do
  if [[ "$arg" == "--image="* ]]; then
    IMAGE="${arg#--image=}"
  fi
done

if [ -z "$IMAGE" ]; then
  echo "Error: --image parameter is required" >&2
  exit 1
fi

# Check if the image is from Amazon ECR
if [[ "$IMAGE" == *".dkr.ecr."*".amazonaws.com"* ]]; then
  # Extract the region from the ECR URL
  REGION=$(echo "$IMAGE" | sed -n 's/.*\.dkr\.ecr\.\([^.]*\)\.amazonaws\.com.*/\1/p')
  
  if [ -z "$REGION" ]; then
    echo "Error: Could not extract region from ECR URL" >&2
    exit 1
  fi
  
  # Get ECR authentication token using AWS CLI
  TOKEN=$(aws ecr get-login-password --region "$REGION" 2>/dev/null)
  
  if [ $? -eq 0 ] && [ -n "$TOKEN" ]; then
    # Return credentials in expected JSON format
    cat << EOF
{
  "auth": {
    "username": "AWS",
    "password": "$TOKEN"
  }
}
EOF
    exit 0
  else
    echo "Error: Failed to get ECR token from AWS CLI" >&2
    exit 1
  fi
fi

# For non-ECR registries, return empty auth
echo "{}"
exit 0
